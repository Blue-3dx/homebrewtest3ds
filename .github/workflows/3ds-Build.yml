name: Build GDWave (3DS .3dsx only)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-3DS:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      image: devkitpro/devkitarm:latest

    env:
      DEVKITPRO: /opt/devkitpro
      DEVKITARM: /opt/devkitpro/devkitARM

    steps:
      - uses: actions/checkout@v4

      - name: Prepare icon if missing (use assets/wave.png)
        run: |
          set -e
          mkdir -p misc/3ds
          if [ ! -f misc/3ds/icon.png ] && [ -f assets/wave.png ]; then
            cp assets/wave.png misc/3ds/icon.png
            echo "Copied assets/wave.png -> misc/3ds/icon.png"
          else
            echo "Icon present or assets/wave.png missing; skipping copy"
          fi

      - name: Show env + devkit listing (debug)
        run: |
          echo "DEVKITPRO=$DEVKITPRO"
          echo "DEVKITARM=$DEVKITARM"
          ls -la $DEVKITPRO || true
          ls -la $DEVKITARM || true

      - name: Build .3dsx (standalone make in 3ds/)
        run: |
          set -e
          cd 3ds
          make clean || true
          make
          ls -la

      - name: Upload .3dsx artifact
        uses: actions/upload-artifact@v4
        with:
          name: GDWave-3dsx
          path: 3ds/GDWave3DS.3dsx
